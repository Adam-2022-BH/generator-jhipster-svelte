<script>
	import { createEventDispatcher } from 'svelte'
	import { faBan } from '@fortawesome/free-solid-svg-icons/faBan.js'
	import { faSave } from '@fortawesome/free-solid-svg-icons/faSave.js'

	import Button from '$lib/Button.svelte'
	import Icon from '$lib/Icon.svelte'
	import InputControl from '$lib/InputControl.svelte'
	import Form from '$lib/page/Form.svelte'

	export let <%= entityInstance %> = {
		id: null,
	<%_	for (field of fields.filter(field => !field.id)) { _%>
		<%= field.fieldName %>: '',
	<%_ } _%>
	}

	const dispatch = createEventDispatcher()

	<%_	for (field of fields.filter(field => !field.id)) { _%>
	let valid<%= field.fieldNameCapitalized %> = false
	<%_ } _%>

	<%_	for (field of fields.filter(field => !field.id)) { _%>
	function update<%= field.fieldNameCapitalized %>(event) {
		<%= entityInstance %>.<%= field.fieldName %> = event.target.value
	}
	<%_ } _%>

	$: validForm = <% let isFirst=true; for (field of fields.filter(field => !field.id)) { %><% if(!isFirst) { %>
		&& <% } %> valid<%= field.fieldNameCapitalized %><%_ isFirst = false } _%>
</script>

<Form testId="add<%= entityAngularName %>">

<%_	for (field of fields.filter(field => !field.id)) { _%>
<%_ if (field.fieldTypeString || field.fieldTypeUUID) { _%>
	<InputControl
		type="text"
		label="<%= field.fieldNameCapitalized %>"
		name="<%= field.fieldName %>"
		value="{<%= entityInstance %>.<%= field.fieldName %>}"
		on:input="{event => update<%= field.fieldNameCapitalized %>(event)}"
		<%_ if (field.fieldValidationRequired) { _%>
		required
		<%_ } _%>
		validations="{[
		<%_ if (field.fieldValidationRequired) { _%>
			{ type: 'required', message: '<%= field.fieldNameCapitalized %> is mandatory' },
		<%_ } _%>
		<%_ if (field.fieldValidationMinLength) { _%>
			{
				type: 'minlength',
				minlength: <%= field.fieldValidateRulesMinlength %>,
				message: '<%= field.fieldNameCapitalized %> should be greater than <%= field.fieldValidateRulesMinlength %> characters',
			},
		<%_ } _%>
		<%_ if (field.fieldValidationMaxLength) { _%>
			{
				type: 'maxlength',
				minlength: <%= field.fieldValidateRulesMaxlength %>,
				message: '<%= field.fieldNameHumanized %> cannot be longer than <%= field.fieldValidateRulesMaxlength %> characters',
			},
		<%_ } _%>
		]}"
		on:validate="{event => {
			valid<%= field.fieldNameCapitalized %> = event.detail.valid
		}}"
	/>
<%_ } _%>
<%_ } _%>
	<div class="w-full p-4 flex flex-row justify-center items-center">
		<div class="mr-4">
			<Button
				name="cancelBtn"
				role="neutral"
				on:click="{() => dispatch('cancel')}"
			>
				<Icon classes="mr-2" icon="{faBan}" />Cancel
			</Button>
		</div>
		<div>
			<Button
				name="saveBtn"
				type="submit"
				on:click="{() => dispatch('saveorupdate', { ...<%= entityInstance %> })}"
				disabled="{!validForm}"
			>
				<Icon classes="mr-2" icon="{faSave}" />
				{<%= entityInstance %>.id ? 'Update ' : 'Create '}
				<%= entityInstance %>
			</Button>
		</div>
	</div>
</Form>
